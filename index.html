<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escape Room Halloween</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Creepster', cursive, Arial, sans-serif;
            background: linear-gradient(135deg, #1a0033, #330066, #4d0080);
            color: #ffffff;
            min-height: 100%;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .mansion-title {
            font-size: 3rem;
            color: #ff6b35;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            margin-bottom: 10px;
            animation: flicker 2s infinite alternate;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .timer {
            background: rgba(0,0,0,0.7);
            padding: 15px 30px;
            border-radius: 15px;
            display: inline-block;
            border: 2px solid #ff6b35;
            margin: 20px 0;
        }

        .timer-text {
            font-size: 1.5rem;
            color: #ff6b35;
            margin: 0;
        }

        .team-setup {
            background: rgba(0,0,0,0.6);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid #8b5cf6;
            text-align: center;
        }

        .team-input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #8b5cf6;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            margin: 15px 0;
        }

        .team-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .start-btn {
            background: linear-gradient(45deg, #ff6b35, #f59e0b);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255,107,53,0.4);
        }

        .challenge-container {
            background: rgba(0,0,0,0.7);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 2px solid #8b5cf6;
            display: none;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .challenge-number {
            background: #ff6b35;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .progress-bar {
            flex: 1;
            background: rgba(255,255,255,0.2);
            height: 10px;
            border-radius: 5px;
            margin: 0 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #ff6b35, #f59e0b);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .challenge-title {
            font-size: 2rem;
            color: #ff6b35;
            margin-bottom: 15px;
            text-align: center;
        }

        .challenge-content {
            font-size: 1.3rem;
            line-height: 1.6;
            margin-bottom: 25px;
            text-align: center;
        }

        .portrait-container {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #8b5cf6;
            text-align: center;
        }

        .portrait-svg {
            border: 4px solid #654321;
            background: #2d1810;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        .answer-input {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #8b5cf6;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            margin: 20px auto;
            display: block;
            text-align: center;
        }

        .answer-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .submit-btn {
            background: linear-gradient(45deg, #8b5cf6, #a855f7);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(139,92,246,0.4);
        }



        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .feedback.correct {
            background: rgba(34,197,94,0.2);
            border: 2px solid #22c55e;
            color: #22c55e;
        }

        .feedback.incorrect {
            background: rgba(239,68,68,0.2);
            border: 2px solid #ef4444;
            color: #ef4444;
        }



        .completion-screen {
            text-align: center;
            padding: 40px;
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            border: 2px solid #22c55e;
            display: none;
        }

        .completion-title {
            font-size: 3rem;
            color: #22c55e;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .final-time {
            font-size: 1.5rem;
            color: #ff6b35;
            margin: 20px 0;
        }

        .restart-btn {
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(34,197,94,0.4);
        }

        .spooky-decoration {
            position: absolute;
            font-size: 2rem;
            opacity: 0.3;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #8b5cf6;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { color: rgba(139,92,246,0); text-shadow: .25em 0 0 rgba(139,92,246,0), .5em 0 0 rgba(139,92,246,0); }
            40% { color: #8b5cf6; text-shadow: .25em 0 0 rgba(139,92,246,0), .5em 0 0 rgba(139,92,246,0); }
            60% { text-shadow: .25em 0 0 #8b5cf6, .5em 0 0 rgba(139,92,246,0); }
            80%, 100% { text-shadow: .25em 0 0 #8b5cf6, .5em 0 0 #8b5cf6; }
        }

        .story-screen {
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid #8b5cf6;
            position: relative;
            overflow: hidden;
        }

        .story-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="20" opacity="0.1">üëªü¶áüï∑Ô∏è</text></svg>') repeat;
            pointer-events: none;
            z-index: 0;
        }

        .story-container {
            position: relative;
            z-index: 1;
        }

        .story-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .story-paragraph {
            background: rgba(0,0,0,0.6);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #4b5563;
            animation: fadeInUp 0.8s ease-out;
        }

        .story-paragraph p {
            font-size: 1.3rem;
            line-height: 1.8;
            color: #e5e7eb;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .story-btn {
            background: linear-gradient(45deg, #8b5cf6, #a855f7);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .story-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139,92,246,0.4);
        }

        .story-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .mansion-title {
                font-size: 2rem;
            }
            
            .challenge-header {
                flex-direction: column;
                text-align: center;
            }
            
            .progress-bar {
                margin: 10px 0;
                width: 100%;
            }
            
            .container {
                padding: 15px;
            }

            .portrait-svg {
                width: 100%;
                max-width: 280px;
                height: auto;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <div class="header">
    <h1 class="mansion-title" id="mansionTitle">El Misterio de la Mansi√≥n Halloween</h1>
    <div class="spooky-decoration" style="top: 10px; left: 10%;">
     ü¶á
    </div>
    <div class="spooky-decoration" style="top: 20px; right: 15%; animation-delay: -1s;">
     üëª
    </div>
    <div class="spooky-decoration" style="top: 30px; left: 80%; animation-delay: -2s;">
     üï∑Ô∏è
    </div>
    <div class="timer">
     <p class="timer-text" id="timerText">‚è∞ Tiempo restante: <span id="timeRemaining">60:00</span></p>
    </div>
   </div><!-- Pantalla de historia inicial -->
   <div class="story-screen" id="storyScreen">
    <div class="story-container">
     <h2 style="color: #ff6b35; font-size: 2.5rem; margin-bottom: 30px; text-align: center;">üìñ La Leyenda de la Mansi√≥n Blackwood</h2>
     <div class="story-content">
      <div class="story-paragraph">
       <p>Era una noche tormentosa de octubre de 1892 cuando el profesor Archibald Blackwood desapareci√≥ misteriosamente de su mansi√≥n...</p>
      </div>
      <div class="story-paragraph" style="display: none;">
       <p>Los vecinos del pueblo contaban que esa noche se escucharon gritos desesperados y luces extra√±as parpadeando en las ventanas de la mansi√≥n.</p>
      </div>
      <div class="story-paragraph" style="display: none;">
       <p>Cuando la polic√≠a lleg√≥ al amanecer, encontraron la casa completamente vac√≠a... excepto por una serie de acertijos escritos con tinta roja en las paredes.</p>
      </div>
      <div class="story-paragraph" style="display: none;">
       <p>Desde entonces, todos los que han intentado entrar en la mansi√≥n han quedado atrapados para siempre... a menos que resuelvan los enigmas del profesor antes de medianoche.</p>
      </div>
      <div class="story-paragraph" style="display: none;">
       <p style="color: #ef4444; font-weight: bold; font-size: 1.3rem; text-align: center;">Esta noche, VOSOTROS sois los siguientes en intentarlo...</p>
       <p style="color: #f59e0b; text-align: center; font-style: italic;">¬øConseguir√©is resolver los misterios del profesor Blackwood y escapar antes de que sea demasiado tarde?</p>
      </div>
     </div>
     <div class="story-controls" style="text-align: center; margin-top: 30px;"><button class="story-btn" id="continueStoryBtn">üëª Continuar la Historia</button> <button class="story-btn" id="skipStoryBtn" style="display: none; background: #6b7280;">‚è≠Ô∏è Saltar Historia</button> <button class="story-btn" id="enterMansionBtn" style="display: none;">üèöÔ∏è Entrar a la Mansi√≥n</button>
     </div>
    </div>
   </div>
   <div class="team-setup" id="teamSetup" style="display: none;">
    <h2 id="welcomeMessage">¬°Bienvenidos a la Mansi√≥n Encantada!</h2>
    <p id="timeLimitText">Tienen 60 minutos para resolver 20 acertijos y escapar antes de medianoche...</p><input type="text" class="team-input" id="teamNameInput" placeholder="Nombre del equipo" maxlength="50"> <br><button class="start-btn" id="startBtn">üéÉ Entrar a la Mansi√≥n</button>
    <div class="loading" id="loadingIndicator" style="display: none;">
     Preparando la mansi√≥n
    </div>
   </div>
   <div class="challenge-container" id="challengeContainer">
    <div class="challenge-header">
     <div class="challenge-number" id="challengeNumber">
      Desaf√≠o 1/20
     </div>
     <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
     </div>
     <div style="color: #ff6b35; font-weight: bold;" id="lettersCollected">
      Letras: 0/15
     </div>
    </div>
    <h2 class="challenge-title" id="challengeTitle">La Puerta Encantada</h2>
    <div class="challenge-content" id="challengeContent">
     <p>Enigma: "Tiene cerradura, pero no se abre con llave. ¬øQu√© es?"</p>
    </div><input type="text" class="answer-input" id="answerInput" placeholder="Escribe tu respuesta aqu√≠..."> <br><button class="submit-btn" id="submitBtn">üîÆ Enviar Respuesta</button>
    <div class="feedback" id="feedback" style="display: none;"></div>
   </div>
   <div class="completion-screen" id="completionScreen">
    <h1 class="completion-title">üéâ ¬°HAB√âIS ESCAPADO! üéâ</h1>
    <p style="font-size: 1.5rem; color: #ffffff;">¬°Felicidades! Hab√©is roto el hechizo de la mansi√≥n</p>
    <div class="final-time" id="finalTime"></div>
    <p style="color: #8b5cf6; font-size: 1.2rem;">Palabra secreta formada: <strong>ESCAPE HALLOWEEN</strong></p><button class="restart-btn" id="restartBtn">üîÑ Nueva Aventura</button>
   </div>
  </div>
  <script>
        // Configuraci√≥n por defecto
        const defaultConfig = {
            mansion_title: "El Misterio de la Mansi√≥n Halloween",
            welcome_message: "¬°Bienvenidos a la Mansi√≥n Encantada!",
            time_limit_text: "Tienen 60 minutos para resolver 20 acertijos y escapar antes de medianoche..."
        };

        // Variables del juego
        let currentTeam = null;
        let currentChallenge = 0;
        let startTime = null;
        let timerInterval = null;
        let gameData = [];
        let lettersCollected = 0;
        let currentStoryParagraph = 0;

        // Desaf√≠os del escape room - NIVEL 1¬∫ ESO
        const challenges = [
            {
                title: "La Puerta Encantada",
                content: 'Enigma: "Tiene cerradura, pero no se abre con llave. ¬øQu√© es?"',
                answer: "contrase√±a",
                hint: "Pista: Es algo digital que protege informaci√≥n...",
                letter: "E"
            },
            {
                title: "El Retrato que Observa",
                content: "portrait", // Marcador especial para el retrato
                answer: "6",
                hint: "Pista: Busca: ojos rojos brillantes, boca siniestra, cabello flotante, collar m√°gico, y las dos manos flotantes a los lados.",
                letter: "S"
            },
            {
                title: "El Caldero de la Bruja",
                content: 'Resuelve esta suma m√°gica: 25 + 17 + 8 = ?',
                answer: "50",
                hint: "Pista: Suma paso a paso: 25 + 17 = 42, luego 42 + 8 = ?",
                letter: "C"
            },
            {
                title: "El Espejo del Alma",
                content: "Descifra este mensaje escrito al rev√©s: NEEWOLLAH",
                answer: "halloween",
                hint: "Pista: Lee las letras de derecha a izquierda...",
                letter: "A"
            },
            {
                title: "El Gato Negro",
                content: 'Enigma: "De noche sale sin ser invitado, ojos brillantes y paso callado."',
                answer: "gato",
                hint: "Pista: Es el compa√±ero tradicional de las brujas...",
                letter: "P"
            },
            {
                title: "El Cementerio de los N√∫meros",
                content: "Completa la serie num√©rica: 5, 10, 15, 20, ?",
                answer: "25",
                hint: "Pista: Cada n√∫mero aumenta en 5...",
                letter: "E"
            },
            {
                title: "La Biblioteca Maldita",
                content: "Ordena estas letras para formar una palabra de Halloween: A-S-M-F-A-T-N-A",
                answer: "fantasma",
                hint: "Pista: Es un esp√≠ritu que aparece en las noches de Halloween...",
                letter: " "
            },
            {
                title: "El Reloj del Tiempo Perdido",
                content: 'Problema de tiempo: Si son las 3:30 y pasan 2 horas y 45 minutos, ¬øqu√© hora ser√°?',
                answer: "6:15",
                hint: "Pista: 3:30 + 2 horas = 5:30, luego suma 45 minutos m√°s...",
                letter: "H"
            },
            {
                title: "El Cofre del Vampiro",
                content: "Resuelve: 8 √ó 7 = ?",
                answer: "56",
                hint: "Pista: Puedes sumar 8 siete veces: 8+8+8+8+8+8+8...",
                letter: "A"
            },
            {
                title: "El Laberinto de las Sombras",
                content: "¬øCu√°ntos lados tiene un hex√°gono?",
                answer: "6",
                hint: "Pista: Piensa en la palabra 'hex' que significa seis...",
                letter: "L"
            },
            {
                title: "La Calabaza Parlante",
                content: 'Enigma: "Soy naranja por fuera, hueca por dentro, y en Halloween me enciendo."',
                answer: "calabaza",
                hint: "Pista: Se talla para hacer Jack-o'-lanterns...",
                letter: "L"
            },
            {
                title: "El Fantasma del Pasillo",
                content: "Si tienes 3 caramelos y tu amigo te da 5 m√°s, luego comes 2, ¬øcu√°ntos te quedan?",
                answer: "6",
                hint: "Pista: 3 + 5 = 8, luego 8 - 2 = ?",
                letter: "O"
            },
            {
                title: "El Hechizo Perdido",
                content: "¬øCu√°l es el resultado de 100 √∑ 4?",
                answer: "25",
                hint: "Pista: ¬øCu√°ntas veces cabe el 4 en 100?",
                letter: "W"
            },
            {
                title: "El Murci√©lago Matem√°tico",
                content: "Resuelve: 15 - 8 + 12 = ?",
                answer: "19",
                hint: "Pista: Hazlo paso a paso: 15 - 8 = 7, luego 7 + 12 = ?",
                letter: "E"
            },
            {
                title: "La Poci√≥n Misteriosa",
                content: "¬øQu√© fracci√≥n representa la mitad de algo?",
                answer: "1/2",
                hint: "Pista: Si divides algo en 2 partes iguales, cada parte es...",
                letter: "E"
            },
            {
                title: "El √öltimo Enigma de la Mansi√≥n",
                content: 'Meta-acertijo final: "Soy el final de todo escape, el objetivo de cada desaf√≠o. Me formas con las letras que has ganado. ¬øQu√© frase formo?"',
                answer: "escape halloween",
                hint: "Pista: Usa todas las letras que has ganado para formar la frase de escape...",
                letter: "N"
            }
        ];

        // Manejo de datos
        const dataHandler = {
            onDataChanged(data) {
                gameData = data;
                updateGameState();
            }
        };

        // Inicializaci√≥n del SDK
        async function initializeApp() {
            try {
                // Solo inicializar si el SDK est√° disponible
                if (window.dataSdk) {
                    const initResult = await window.dataSdk.init(dataHandler);
                    if (!initResult.isOk) {
                        console.error("Error inicializando Data SDK");
                    }
                }
            } catch (error) {
                console.error("Error en inicializaci√≥n:", error);
            }

            // Inicializar Element SDK
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        const mansionTitle = document.getElementById('mansionTitle');
                        const welcomeMessage = document.getElementById('welcomeMessage');
                        const timeLimitText = document.getElementById('timeLimitText');

                        if (mansionTitle) {
                            mansionTitle.textContent = config.mansion_title || defaultConfig.mansion_title;
                        }
                        if (welcomeMessage) {
                            welcomeMessage.textContent = config.welcome_message || defaultConfig.welcome_message;
                        }
                        if (timeLimitText) {
                            timeLimitText.textContent = config.time_limit_text || defaultConfig.time_limit_text;
                        }
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.primary_color || "#ff6b35",
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.setConfig({ primary_color: value });
                                    }
                                }
                            },
                            {
                                get: () => config.secondary_color || "#8b5cf6",
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.setConfig({ secondary_color: value });
                                    }
                                }
                            },
                            {
                                get: () => config.background_color || "#1a0033",
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.setConfig({ background_color: value });
                                    }
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: {
                            get: () => config.font_family || "Creepster",
                            set: (value) => {
                                if (window.elementSdk) {
                                    window.elementSdk.setConfig({ font_family: value });
                                }
                            }
                        },
                        fontSizeable: {
                            get: () => config.font_size || 16,
                            set: (value) => {
                                if (window.elementSdk) {
                                    window.elementSdk.setConfig({ font_size: value });
                                }
                            }
                        }
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["mansion_title", config.mansion_title || defaultConfig.mansion_title],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                        ["time_limit_text", config.time_limit_text || defaultConfig.time_limit_text]
                    ])
                });
            }
        }

        // Actualizar estado del juego
        function updateGameState() {
            // Esta funci√≥n se ejecuta cuando cambian los datos
        }

        // Crear retrato embrujado
        function createPortrait() {
            return `
                <p>Observa atentamente este retrato embrujado. Cuenta cu√°ntos elementos extra√±os puedes encontrar:</p>
                <div class="portrait-container">
                    <svg class="portrait-svg" width="280" height="350" viewBox="0 0 280 350">
                        <!-- Fondo del retrato -->
                        <rect width="280" height="350" fill="#1a0d06"/>
                        
                        <!-- Cara fantasmal -->
                        <ellipse cx="140" cy="150" rx="50" ry="70" fill="#e6e6fa" opacity="0.9"/>
                        
                        <!-- Ojos rojos brillantes (extra√±o 1 y 2) -->
                        <circle cx="125" cy="135" r="6" fill="#ff0000">
                            <animate attributeName="opacity" values="1;0.5;1" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="155" cy="135" r="6" fill="#ff0000">
                            <animate attributeName="opacity" values="1;0.5;1" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        
                        <!-- Nariz normal -->
                        <path d="M 140 145 L 136 155 L 144 155 Z" fill="#d3d3d3"/>
                        
                        <!-- Boca siniestra (extra√±o 3) -->
                        <path d="M 125 170 Q 140 185 155 170" stroke="#8b0000" stroke-width="2" fill="none"/>
                        
                        <!-- Cabello flotante (extra√±o 4) -->
                        <path d="M 90 100 Q 115 85 140 95 Q 165 85 190 100" stroke="#2f2f2f" stroke-width="3" fill="none">
                            <animateTransform attributeName="transform" type="translate" values="0,0; 0,-3; 0,0" dur="3s" repeatCount="indefinite"/>
                        </path>
                        
                        <!-- Collar brillante m√°gico (extra√±o 5) -->
                        <rect x="132" y="200" width="16" height="6" fill="#4b0082"/>
                        <circle cx="140" cy="203" r="4" fill="#ff00ff">
                            <animate attributeName="fill" values="#ff00ff;#00ffff;#ff00ff" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                        
                        <!-- Mano flotante izquierda (extra√±o 6) -->
                        <ellipse cx="50" cy="200" rx="12" ry="20" fill="#e6e6fa" opacity="0.7">
                            <animateTransform attributeName="transform" type="translate" values="0,0; -5,0; 0,0" dur="4s" repeatCount="indefinite"/>
                        </ellipse>
                        
                        <!-- Mano flotante derecha (extra√±o 7) - BONUS -->
                        <ellipse cx="230" cy="200" rx="12" ry="20" fill="#e6e6fa" opacity="0.7">
                            <animateTransform attributeName="transform" type="translate" values="0,0; 5,0; 0,0" dur="4s" repeatCount="indefinite"/>
                        </ellipse>
                        
                        <!-- Marco decorativo -->
                        <rect x="5" y="5" width="270" height="340" fill="none" stroke="#654321" stroke-width="3"/>
                    </svg>
                </div>
                <p style="color: #f59e0b; font-style: italic; font-size: 1.1rem;">
                    üí° Un retrato normal tendr√≠a: ojos normales (no rojos), boca normal (no siniestra), 
                    cabello normal (no flotante), sin objetos m√°gicos brillantes, sin manos flotantes...
                </p>
            `;
        }

        // Iniciar juego
        async function startGame() {
            const teamName = document.getElementById('teamNameInput').value.trim();
            if (!teamName) {
                showCustomAlert("Por favor, introduce el nombre del equipo");
                return;
            }

            if (gameData.length >= 999) {
                showCustomAlert("Se ha alcanzado el l√≠mite m√°ximo de 999 equipos. Por favor, contacta al administrador.");
                return;
            }

            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('startBtn').disabled = true;

            try {
                // Verificar si el SDK est√° disponible
                if (!window.dataSdk) {
                    // Si no hay SDK, continuar sin persistencia
                    currentTeam = teamName;
                    currentChallenge = 0;
                    lettersCollected = 0;
                    startTime = Date.now();
                    
                    document.getElementById('teamSetup').style.display = 'none';
                    document.getElementById('challengeContainer').style.display = 'block';
                    
                    startTimer();
                    loadChallenge(0);
                    return;
                }

                const result = await window.dataSdk.create({
                    team_name: teamName,
                    current_challenge: 0,
                    completed_challenges: "",
                    start_time: new Date().toISOString(),
                    completion_time: ""
                });

                if (result.isOk) {
                    currentTeam = teamName;
                    currentChallenge = 0;
                    lettersCollected = 0;
                    startTime = Date.now();
                    
                    document.getElementById('teamSetup').style.display = 'none';
                    document.getElementById('challengeContainer').style.display = 'block';
                    
                    startTimer();
                    loadChallenge(0);
                } else {
                    // Si falla el SDK, continuar sin persistencia
                    currentTeam = teamName;
                    currentChallenge = 0;
                    lettersCollected = 0;
                    startTime = Date.now();
                    
                    document.getElementById('teamSetup').style.display = 'none';
                    document.getElementById('challengeContainer').style.display = 'block';
                    
                    startTimer();
                    loadChallenge(0);
                }
            } catch (error) {
                // Si hay error, continuar sin persistencia
                currentTeam = teamName;
                currentChallenge = 0;
                lettersCollected = 0;
                startTime = Date.now();
                
                document.getElementById('teamSetup').style.display = 'none';
                document.getElementById('challengeContainer').style.display = 'block';
                
                startTimer();
                loadChallenge(0);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('startBtn').disabled = false;
            }
        }

        // Cargar desaf√≠o
        function loadChallenge(index) {
            if (index >= challenges.length) {
                completeGame();
                return;
            }

            const challenge = challenges[index];
            document.getElementById('challengeNumber').textContent = `Desaf√≠o ${index + 1}/20`;
            document.getElementById('challengeTitle').textContent = challenge.title;
            
            // Contenido especial para el retrato
            if (challenge.content === "portrait") {
                document.getElementById('challengeContent').innerHTML = createPortrait();
            } else {
                document.getElementById('challengeContent').innerHTML = `<p>${challenge.content}</p>`;
            }
            
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('hintText').style.display = 'none';
            
            // Actualizar progreso
            const progress = ((index) / challenges.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('lettersCollected').textContent = `Letras: ${lettersCollected}/15`;
        }

        // Enviar respuesta
        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim().toLowerCase();
            const challenge = challenges[currentChallenge];
            
            if (!answer) {
                showFeedback("Por favor, escribe una respuesta", "incorrect");
                return;
            }

            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = "Verificando...";

            // Simular verificaci√≥n
            setTimeout(async () => {
                if (answer === challenge.answer.toLowerCase() || 
                    (challenge.answer === "alow" && answer === "allow") ||
                    (challenge.answer === "escape halloween" && (answer === "escape halloween" || answer === "escapar halloween"))) {
                    
                    showFeedback(`¬°Correcto! Has ganado la letra: ${challenge.letter}`, "correct");
                    lettersCollected++;
                    currentChallenge++;
                    
                    try {
                        // Solo intentar guardar si el SDK est√° disponible
                        if (window.dataSdk && gameData.length > 0) {
                            const teamRecord = gameData.find(record => record.team_name === currentTeam);
                            if (teamRecord) {
                                const result = await window.dataSdk.update({
                                    ...teamRecord,
                                    current_challenge: currentChallenge,
                                    completed_challenges: teamRecord.completed_challenges + challenge.letter
                                });
                                
                                if (!result.isOk) {
                                    console.error("Error actualizando progreso");
                                }
                            }
                        }
                    } catch (error) {
                        console.error("Error al guardar progreso:", error);
                    }
                    
                    setTimeout(() => {
                        if (currentChallenge < challenges.length) {
                            loadChallenge(currentChallenge);
                        } else {
                            completeGame();
                        }
                    }, 2000);
                } else {
                    showFeedback("Respuesta incorrecta. ¬°Int√©ntalo de nuevo!", "incorrect");
                }
                
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = "üîÆ Enviar Respuesta";
            }, 1000);
        }



        // Mostrar feedback
        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
            feedback.style.display = 'block';
        }

        // Completar juego
        async function completeGame() {
            clearInterval(timerInterval);
            const endTime = Date.now();
            const totalTime = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;
            
            try {
                // Solo intentar guardar si el SDK est√° disponible
                if (window.dataSdk && gameData.length > 0) {
                    const teamRecord = gameData.find(record => record.team_name === currentTeam);
                    if (teamRecord) {
                        const result = await window.dataSdk.update({
                            ...teamRecord,
                            completion_time: new Date().toISOString()
                        });
                    }
                }
            } catch (error) {
                console.error("Error al guardar tiempo de finalizaci√≥n:", error);
            }
            
            document.getElementById('challengeContainer').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'block';
            document.getElementById('finalTime').textContent = `Tiempo total: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Timer
        function startTimer() {
            let timeLeft = 60 * 60; // 60 minutos en segundos
            
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                document.getElementById('timeRemaining').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showCustomAlert("¬°Se acab√≥ el tiempo! La mansi√≥n os ha atrapado para siempre...");
                    setTimeout(() => {
                        restartGame();
                    }, 3000);
                }
            }, 1000);
        }

        // Funciones de la historia
        function continueStory() {
            const paragraphs = document.querySelectorAll('.story-paragraph');
            
            if (currentStoryParagraph < paragraphs.length - 1) {
                currentStoryParagraph++;
                paragraphs[currentStoryParagraph].style.display = 'block';
                
                // Mostrar bot√≥n de saltar despu√©s del segundo p√°rrafo
                if (currentStoryParagraph >= 1) {
                    document.getElementById('skipStoryBtn').style.display = 'inline-block';
                }
                
                // Cambiar bot√≥n en el √∫ltimo p√°rrafo
                if (currentStoryParagraph === paragraphs.length - 1) {
                    document.getElementById('continueStoryBtn').style.display = 'none';
                    document.getElementById('enterMansionBtn').style.display = 'inline-block';
                }
            }
        }

        function skipStory() {
            const paragraphs = document.querySelectorAll('.story-paragraph');
            
            // Mostrar todos los p√°rrafos
            paragraphs.forEach(paragraph => {
                paragraph.style.display = 'block';
            });
            
            // Cambiar botones
            document.getElementById('continueStoryBtn').style.display = 'none';
            document.getElementById('skipStoryBtn').style.display = 'none';
            document.getElementById('enterMansionBtn').style.display = 'inline-block';
            
            currentStoryParagraph = paragraphs.length - 1;
        }

        function enterMansion() {
            document.getElementById('storyScreen').style.display = 'none';
            document.getElementById('teamSetup').style.display = 'block';
        }

        // Reiniciar juego
        function restartGame() {
            clearInterval(timerInterval);
            currentTeam = null;
            currentChallenge = 0;
            lettersCollected = 0;
            startTime = null;
            currentStoryParagraph = 0;
            
            // Resetear historia
            const paragraphs = document.querySelectorAll('.story-paragraph');
            paragraphs.forEach((paragraph, index) => {
                paragraph.style.display = index === 0 ? 'block' : 'none';
            });
            
            document.getElementById('continueStoryBtn').style.display = 'inline-block';
            document.getElementById('skipStoryBtn').style.display = 'none';
            document.getElementById('enterMansionBtn').style.display = 'none';
            
            document.getElementById('teamNameInput').value = '';
            document.getElementById('timeRemaining').textContent = '60:00';
            document.getElementById('challengeContainer').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'none';
            document.getElementById('teamSetup').style.display = 'none';
            document.getElementById('storyScreen').style.display = 'block';
        }

        // Mostrar alerta personalizada
        function showCustomAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.9);
                color: #ff6b35;
                padding: 30px;
                border-radius: 15px;
                border: 2px solid #ff6b35;
                z-index: 1000;
                text-align: center;
                font-size: 1.2rem;
                max-width: 400px;
            `;
            alertDiv.textContent = message;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Cerrar';
            closeBtn.style.cssText = `
                background: #ff6b35;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                margin-top: 15px;
                cursor: pointer;
            `;
            closeBtn.onclick = () => document.body.removeChild(alertDiv);
            
            alertDiv.appendChild(document.createElement('br'));
            alertDiv.appendChild(closeBtn);
            document.body.appendChild(alertDiv);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            
            // Event listeners de la historia
            document.getElementById('continueStoryBtn').addEventListener('click', continueStory);
            document.getElementById('skipStoryBtn').addEventListener('click', skipStory);
            document.getElementById('enterMansionBtn').addEventListener('click', enterMansion);
            
            // Event listeners del juego
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('submitBtn').addEventListener('click', submitAnswer);
            document.getElementById('restartBtn').addEventListener('click', restartGame);
            
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitAnswer();
                }
            });
            
            document.getElementById('teamNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startGame();
                }
            });
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'996dcf1ca154cfc7',t:'MTc2MTg1NzY3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
